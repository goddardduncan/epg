<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="https://epg.dunc.app/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live TV</title>

    <style>
        html, body, #video-container {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        #video {
            width: 100%;
            height: 100%;
        }

        #video-description {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            background-color: rgba(0,0,0,0.5);
            color: #fff;
            padding: 10px;
            text-align: center;
            font-size: 1.5em;
            font-family: 'Roboto', sans-serif;
            box-sizing: border-box;
            display: none;
        }

        /* Optional small debug label (disabled by default) */
        #channel-source-debug {
            position: absolute;
            top: 5px;
            right: 10px;
            background: rgba(0,0,0,0.4);
            padding: 4px 8px;
            color: #fff;
            font-size: 12px;
            border-radius: 4px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="video-container">
        <video id="video" autoplay controls></video>
        <div id="video-description"></div>

        <!-- Debug overlay to show which JSON is being used -->
        <div id="channel-source-debug"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <script>
        /********************************************
         *  SHARED SETTING FROM THE MAIN TV GUIDE   *
         ********************************************/
        const channelSourceKey = 'channelSource';
        const channelSource = localStorage.getItem(channelSourceKey) || 'channels.json';

        // Show debug indicator
        document.getElementById('channel-source-debug').innerText = channelSource;


        /***********************
         * CHANNEL ORDER LOADING
         ***********************/
        async function loadChannelOrder() {
            try {
                const response = await fetch('channelorder.json');
                if (!response.ok) throw new Error('Channel order load error');
                return await response.json();
            } catch (e) {
                console.error('Failed to load channelorder.json:', e);
                return [];
            }
        }


        /************************************
         * LOAD LINKS FROM THE SELECTED JSON
         ************************************/
        async function loadChannelLinkMap() {
            try {
                const response = await fetch(channelSource);
                if (!response.ok) throw new Error('Link map load error');
                const map = await response.json();
                console.log('Loaded links from', channelSource);
                return map;
            } catch (e) {
                console.error('Failed to load channel link map:', e);
                return {};
            }
        }


        /***************************
         * URL PARAM GETTER HELPERS
         ***************************/
        function getUrlParameter(name) {
            const regex = new RegExp('[?&]' + name + '=([^&#]*)');
            const result = regex.exec(location.search);
            return result ? decodeURIComponent(result[1]) : '';
        }

        function getUrlParameterCheck(name, url) {
            const base = 'https://goddardduncan.github.io/epg/';
            return url.slice(url.indexOf(base) + base.length);
        }


        /********************
         * HLS STREAM LOADER
         ********************/
        async function loadAndPlayStream(url) {
            const video = document.getElementById('video');

            if (Hls.isSupported()) {
                const hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                video.play();
            } else {
                alert("HLS playback not supported.");
            }
        }


        /*********************************
         * AUTO-DISABLE SUBTITLE TRACKS
         *********************************/
        function disableSubtitles() {
            const video = document.getElementById('video');
            const tracks = video.textTracks;
            let found = false;

            for (let t of tracks) {
                if (t.kind === 'subtitles' || t.kind === 'captions') {
                    t.mode = 'hidden';
                    found = true;
                }
            }
            return found;
        }


        /*******************************
         * MAIN PLAYER INITIALIZATION
         *******************************/
        document.addEventListener("DOMContentLoaded", async () => {

            const channelsOrder = await loadChannelOrder();
            const channelLinkMap = await loadChannelLinkMap();

            const urlParameter = getUrlParameter('url');
            const streamKey = getUrlParameter('stream');
            const urlCheck = getUrlParameterCheck('url', location.href);

            const video = document.getElementById('video');


            /*****************************
             * LOAD STREAM BASED ON URL
             *****************************/
            if (urlParameter) {
                loadAndPlayStream(urlParameter);

            } else if (streamKey) {
                const stored = JSON.parse(localStorage.getItem('m3u8Files') || '{}');
                if (stored[streamKey]) {
                    const blob = new Blob([stored[streamKey]], { type: 'application/vnd.apple.mpegurl' });
                    loadAndPlayStream(URL.createObjectURL(blob));
                } else {
                    alert("Stream not found in localStorage.");
                }
            }


            /***************************************
             * SUBTITLE DISABLING LOOP (AUTO-HIDE)
             ***************************************/
            const subtitleInterval = setInterval(() => {
                if (disableSubtitles()) {
                    setTimeout(disableSubtitles, 2000);
                    clearInterval(subtitleInterval);
                }
            }, 500);


            /*********************
             * DETERMINE CHANNEL
             *********************/
            let selectedChannel = localStorage.getItem('selectedChannel');
            let isMatch = false;

            if (selectedChannel && channelLinkMap[selectedChannel] === urlCheck) {
                isMatch = true;
            }

            if (!isMatch && urlCheck) {
                for (const id in channelLinkMap) {
                    if (channelLinkMap[id] === urlCheck) {
                        selectedChannel = id;
                        localStorage.setItem('selectedChannel', id);
                        break;
                    }
                }
            }

            const currentIndex = channelsOrder.findIndex(c => c.id === selectedChannel);
            const prevId = localStorage.getItem('prevChannel');
            const prevIndex = channelsOrder.findIndex(c => c.id === prevId);

            const currentChannelObj = channelsOrder.find(c => c.id === selectedChannel);
            document.title = currentChannelObj ? currentChannelObj.name : "Live TV";

            localStorage.setItem("Matchey", String(isMatch));


            /*****************************************
             * ENABLE RIGHT-CLICK TOGGLE SUBTITLES
             *****************************************/
            video.addEventListener("contextmenu", ev => {
                ev.preventDefault();
                const tracks = video.textTracks;
                for (let t of tracks) {
                    if (t.kind === 'subtitles' || t.kind === 'captions')
                        t.mode = t.mode === 'showing' ? 'hidden' : 'showing';
                }
            });


            /*****************************
             * KEYBOARD NAVIGATION LOGIC
             *****************************/
            window.addEventListener("keydown", ev => {

                if (ev.key === "Enter") {
                    video.play();
                }

                else if (ev.key === "Escape" ||
                        (ev.key === "ArrowLeft" && ev.metaKey)) {
                    ev.preventDefault();
                    const back = channelsOrder[prevIndex];
                    if (!back) return;
                    localStorage.setItem('prevChannel', back.id);
                    location.href = channelLinkMap[back.id];
                }

                else if (ev.key === "ArrowLeft") {
                    let idx = currentIndex - 1;
                    if (idx < 0) idx = channelsOrder.length - 1;
                    const prev = channelsOrder[idx];
                    localStorage.setItem('selectedChannel', prev.id);
                    location.href = channelLinkMap[prev.id];
                }

                else if (ev.key === "ArrowRight") {
                    let idx = (currentIndex + 1) % channelsOrder.length;
                    const next = channelsOrder[idx];
                    localStorage.setItem('selectedChannel', next.id);
                    location.href = channelLinkMap[next.id];
                }

                else if (ev.key === "ArrowUp") {
                    const desc = document.getElementById('video-description');
                    desc.style.display = desc.style.display === 'block' ? 'none' : 'block';
                }

                else if (ev.key === "ArrowDown") {
                    video.muted = !video.muted;

                    // Auto enable subtitles if muted
                    const tracks = video.textTracks;
                    for (let t of tracks) {
                        if (t.kind === 'subtitles' || t.kind === 'captions') {
                            t.mode = video.muted ? 'showing' : 'hidden';
                        }
                    }
                }
            });


            /**********************************
             * LOAD CURRENT PROGRAM DESCRIPTION
             **********************************/
            const xmlUrl = "https://epg.dunc.app/epg.xml";

            if (selectedChannel) {
                fetch(xmlUrl)
                    .then(r => r.text())
                    .then(t => new DOMParser().parseFromString(t, "text/xml"))
                    .then(xml => {
                        const now = new Date();
                        now.setMinutes(now.getMinutes() + now.getTimezoneOffset());

                        const progs = xml.getElementsByTagName("programme");
                        for (const p of progs) {
                            if (p.getAttribute("channel") !== selectedChannel) continue;

                            const start = parseEpgDate(p.getAttribute("start"));
                            const stop  = parseEpgDate(p.getAttribute("stop"));

                            if (now >= start && now <= stop) {
                                const desc = p.getElementsByTagName("desc")[0];
                                const text = desc ? desc.textContent : "No description available";
                                document.getElementById("video-description").innerText = text;
                                localStorage.setItem("descripto", text);
                                break;
                            }
                        }
                    });
            }

            function parseEpgDate(str) {
                return new Date(
                    str.replace(" +0000", "")
                       .replace(/(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/,
                                "$1-$2-$3T$4:$5:$6")
                );
            }
        });
    </script>
</body>
</html>
