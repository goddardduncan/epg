<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>m3u8 Stream Player</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
        }
        video {
            width: 80%;
            max-width: 800px;
            margin-top: 20px;
            border: 2px solid #333;
        }
        .controls {
            margin-top: 10px;
        }
        .controls button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>m3u8 Stream Player</h1>
    <video id="videoPlayer" controls autoplay></video>
    <div class="controls">
        <button onclick="changeChannel('mjh-channel-9-vic')">Channel 9</button>
        <button onclick="changeChannel('mjh-gem-vic')">GEM</button>
        <button onclick="changeChannel('mjh-go-vic')">GO</button>
        <button onclick="changeChannel('mjh-life-vic')">LIFE</button>
        <button onclick="changeChannel('mjh-rush-vic')">RUSH</button>
    </div>

    <!-- Include HLS.js from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script>
        const streamFilenames = {
            "mjh-channel-9-vic": "m3u8/9.m3u8",
            "mjh-gem-vic": "m3u8/9gem.m3u8",
            "mjh-go-vic": "m3u8/9go.m3u8",
            "mjh-life-vic": "m3u8/9life.m3u8",
            "mjh-rush-vic": "m3u8/9rush.m3u8"
        };

        const videoPlayer = document.getElementById('videoPlayer');

        async function fetchStreams() {
            try {
                const response = await fetch("https://goddardduncan.github.io/epg/9now.txt");
                if (response.ok) {
                    const allStreams = await response.json();
                    return {
                        "mjh-channel-9-vic": allStreams["mjh-channel-9-vic"],
                        "mjh-gem-vic": allStreams["mjh-gem-vic"],
                        "mjh-go-vic": allStreams["mjh-go-vic"],
                        "mjh-life-vic": allStreams["mjh-life-vic"],
                        "mjh-rush-vic": allStreams["mjh-rush-vic"]
                    };
                } else {
                    throw new Error('Failed to fetch stream URLs');
                }
            } catch (error) {
                console.error('Error fetching streams:', error);
            }
        }

        async function fetchAndStoreFile(url, streamKey) {
            try {
                const response = await fetch(url);
                if (response.ok) {
                    const m3u8Content = await response.text();

                    // Retrieve current storage or initialize as empty object
                    let storedContent = JSON.parse(localStorage.getItem('m3u8Files')) || {};

                    // Update stored content
                    storedContent[streamKey] = m3u8Content;

                    // Save back to localStorage
                    localStorage.setItem('m3u8Files', JSON.stringify(storedContent));

                    console.log('Saved m3u8 file for ' + streamKey);
                } else {
                    console.error('Failed to fetch m3u8 file from ' + url);
                }
            } catch (error) {
                console.error('Error fetching m3u8 file:', error);
            }
        }

        async function startSavingToLocalStorage() {
            try {
                const streams = await fetchStreams();
                if (streams) {
                    let delay = 0;
                    for (let streamKey in streams) {
                        let streamUrl = streams[streamKey];
                        setTimeout(() => {
                            fetchAndStoreFile(streamUrl, streamKey);
                        }, delay);
                        delay += 10000; // Increase the delay by 10 seconds (10000 milliseconds) for each iteration
                    }
                }
            } catch (error) {
                console.error('Error during saving to local storage:', error);
            }
        }

        function changeChannel(channelKey) {
            // Retrieve the stored m3u8 files from localStorage
            const m3u8Files = JSON.parse(localStorage.getItem('m3u8Files'));

            if (m3u8Files && m3u8Files[channelKey]) {
                const blob = new Blob([m3u8Files[channelKey]], { type: 'application/vnd.apple.mpegurl' });
                const url = URL.createObjectURL(blob);

                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(url);
                    hls.attachMedia(videoPlayer);
                    hls.on(Hls.Events.MANIFEST_PARSED, function() {
                        videoPlayer.play();
                    });
                } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                    // For Safari, which natively supports HLS
                    videoPlayer.src = url;
                    videoPlayer.play();
                } else {
                    alert('Your browser does not support HLS.js or native HLS playback.');
                }
            } else {
                alert('Channel not available or m3u8 data is missing.');
            }
        }

        // Automatically load the first channel on page load
        window.onload = () => {
            startSavingToLocalStorage();
            changeChannel('mjh-channel-9-vic');
        };

        // Run the script every 5 minutes (300000 milliseconds)
        setInterval(startSavingToLocalStorage, 300000);

    </script>
</body>
</html>
