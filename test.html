<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="https://goddardduncan.github.io/epg/favicon.ico" type="image/x-icon">
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="300">
    <title>Melbourne Live TV Guide</title>
    <style>
        body {
            background-color: #1e2d3b;
            color: #d4d4d4;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        h1 {
            text-align: center;
            font-size: 36px;
            margin: 20px 0;
            color: #4f5e80;
        }
        table {
            border-collapse: collapse;
            margin: 20px auto;
            width: 95%;
            max-width: 1200px;
            background-color: #263544;
            border-radius: 8px;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #33475b;
            position: relative;
        }
        th {
            background-color: #33475b;
            color: #ffffff;
            font-size: 18px;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        img {
            width: 100px;
            height: 60px;
            border-radius: 8px;
        }
        tr:not(:first-child).selected {
            background-color: #13508a;
            color: #FFFFFF;
        }
        .progress-bar {
            position: absolute;
            width: 23px;
            height: 10%;
            background-color: rgba(255, 255, 255, 0.5); 
            bottom: 3px; 
            left: 0;
            border-radius: 5px; 
            transition: background-color 0.3s ease;
        }

        .progress-bar:hover {
            background-color: rgba(255, 255, 255, 0.8);
        }

        .knob {
            position: absolute;
            bottom: 14px;
            left: 0;
            padding: 5px 10px;
            background-color: #4f5e80;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transform: translateX(-50%);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none; /* Ensure the knob itself does not interfere with hover */
        }

        .progress-bar:hover .knob {
            opacity: 1;
            transform: translateX(-50%) scale(1.1); /* Slightly enlarge the knob */
        }

        #refreshButton {
            margin: 10px;
            padding: 10px;
            background-color: #4f5e80;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #refreshButton:hover {
            background-color: #3a4a6b;
        }

        #mobileButtons {
            text-align: center;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <h1>Melbourne Live TV Guide</h1>
    <button id="refreshButton">Refresh</button>
    <table>
        <tr>
            <th>Channel</th> 
            <th></th>
            <th>What's Playing</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>What's Up Next</th>
            <th>Start Time</th>
            <th>End Time</th>
        </tr>

        <!-- Your existing JavaScript code here -->
        <script>
            async function loadChannelMap() {
                try {
                    const response = await fetch('channelorder.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const channelOrder = await response.json();
                    const channelMap = channelOrder.reduce((map, channel) => {
                        map[channel.id] = channel.name;
                        return map;
                    }, {});
                    return channelMap;
                } catch (error) {
                    console.error('Failed to load channel order:', error);
                    return {};
                }
            }

            async function loadChannelLinkMap() {
                try {
                    const response = await fetch('channels.json');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const channelLinkMap = await response.json();
                    return channelLinkMap;
                } catch (error) {
                    console.error('Failed to load channel links:', error);
                    return {};
                }
            }

            async function fetchStreams() {
                try {
                    const response = await fetch('https://goddardduncan.github.io/epg/9now.json');
                    if (!response.ok) {
                        throw new Error(`Failed to fetch stream URLs: ${response.statusText}`);
                    }
                    const allStreams = await response.json();
                    return {
                        "mjh-channel-9-vic": allStreams["mjh-channel-9-vic"],
                        "mjh-gem-vic": allStreams["mjh-gem-vic"],
                        "mjh-go-vic": allStreams["mjh-go-vic"],
                        "mjh-life-vic": allStreams["mjh-life-vic"],
                        "mjh-rush-vic": allStreams["mjh-rush-vic"]
                    };
                } catch (error) {
                    console.error('Error fetching streams:', error);
                    return {};
                }
            }

            function fetchAndStoreFile(url, streamKey) {
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Failed to fetch m3u8 file from ${url}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(m3u8Content => {
                        let storedContent = JSON.parse(localStorage.getItem('m3u8Files')) || {};
                        storedContent[streamKey] = m3u8Content;
                        localStorage.setItem('m3u8Files', JSON.stringify(storedContent));
                        console.log('Saved m3u8 file for ' + streamKey);
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }

            async function startSavingToLocalStorage() {
                try {
                    const streams = await fetchStreams();
                    let delay = 0;
                    for (let streamKey in streams) {
                        let streamUrl = streams[streamKey];
                        setTimeout(() => {
                            fetchAndStoreFile(streamUrl, streamKey);
                        }, delay);
                        delay += 1000;
                    }
                    setTimeout(startSavingToLocalStorage, 100000);
                } catch (error) {
                    console.error('Error during saving to local storage:', error);
                }
            }

            function createProgressBar(adjustedStart, adjustedEnd, cell) {
                try {
                    const timezoneOffsetInMinutes = new Date().getTimezoneOffset();
                    const currentTimeUTC = new Date(new Date().getTime() + timezoneOffsetInMinutes * 60 * 1000);

                    if (currentTimeUTC >= adjustedStart && currentTimeUTC <= adjustedEnd) {
                        const duration = adjustedEnd - adjustedStart;
                        const remainingTime = Math.floor((adjustedEnd - currentTimeUTC) / (1000 * 60)); // Remaining time in minutes
                        const progressPercentage = ((currentTimeUTC - adjustedStart) / duration) * 100;
                        const progressBar = document.createElement('div');
                        progressBar.className = 'progress-bar';
                        progressBar.style.left = progressPercentage + '%';
                        cell.style.position = 'relative';

                        // Create the knob
                        const knob = document.createElement('div');
                        knob.className = 'knob';
                        knob.innerText = `${remainingTime} minutes remain`; // Display remaining time
                        progressBar.appendChild(knob); // Attach the knob to the progress bar

                        cell.appendChild(progressBar);
                    } else {
                        console.log('Current time is outside the program time range');
                    }
                } catch (error) {
                    console.error('Error creating progress bar:', error);
                }
            }

            async function initTVGuide() {
                const channelMap = await loadChannelMap();
                const channelLinkMap = await loadChannelLinkMap();
                startSavingToLocalStorage();
                let selectedRowIndex = -1;

                document.addEventListener("keydown", function(event) {
                    event.preventDefault();
                    const tableRows = document.querySelectorAll('table tr');
                    if (event.key === "ArrowUp") {
                        if (selectedRowIndex > 0) {
                            tableRows[selectedRowIndex].classList.remove("selected");
                            selectedRowIndex--;
                            tableRows[selectedRowIndex].classList.add("selected");
                            tableRows[selectedRowIndex].scrollIntoView({ behavior: "smooth", block: "center" });
                        }
                    } else if (event.key === "ArrowDown") {
                        if (selectedRowIndex < tableRows.length - 1) {
                            tableRows[selectedRowIndex].classList.remove("selected");
                            selectedRowIndex++;
                            tableRows[selectedRowIndex].classList.add("selected");
                            tableRows[selectedRowIndex].scrollIntoView({ behavior: "smooth", block: "center" });
                        }
                    }
                });

                const response = await fetch('https://goddardduncan.github.io/epg/tv_guide.json');
                const data = await response.json();
                const table = document.querySelector('table');
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    const cells = [
                        channelMap[row.channel_id] || row.channel_id,
                        row.image,
                        row.program_name,
                        row.start_time,
                        row.end_time,
                        row.next_program_name,
                        row.next_start_time,
                        row.next_end_time
                    ];

                    cells.forEach((cell, index) => {
                        const td = document.createElement('td');
                        if (index === 1 && cell) {
                            const img = document.createElement('img');
                            img.src = cell;
                            td.appendChild(img);
                        } else {
                            td.textContent = cell;
                        }
                        tr.appendChild(td);
                    });

                    const startTime = new Date(row.start_time).getTime();
                    const endTime = new Date(row.end_time).getTime();
                    const adjustedStart = new Date(startTime - new Date().getTimezoneOffset() * 60000);
                    const adjustedEnd = new Date(endTime - new Date().getTimezoneOffset() * 60000);

                    createProgressBar(adjustedStart, adjustedEnd, tr.cells[0]); // Adjust index based on where you want the progress bar

                    table.appendChild(tr);
                });
            }

            initTVGuide();

            document.getElementById('refreshButton').addEventListener('click', async () => {
                await fetch('https://api.github.com/gists/0b5b84b7dbad52d89f803fe6e5b606dd')
                    .then(response => response.json())
                    .then(gist => {
                        const file = gist.files['refresh.now'];
                        const newContent = (parseInt(file.content) + 1).toString();
                        return fetch(`https://api.github.com/gists/0b5b84b7dbad52d89f803fe6e5b606dd`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `token YOUR_GITHUB_TOKEN`
                            },
                            body: JSON.stringify({
                                files: {
                                    'refresh.now': {
                                        content: newContent
                                    }
                                }
                            })
                        });
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Gist updated successfully:', data);
                    })
                    .catch(error => {
                        console.error('Error updating gist:', error);
                    });
            });
        </script>
    </table>
    <div id="mobileButtons">
        <!-- You can add mobile-specific buttons or controls here -->
    </div>
</body>
</html>
